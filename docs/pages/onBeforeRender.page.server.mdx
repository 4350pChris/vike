import { HookTypeScriptHints, IntegrationPackageNames } from '../components'
import { Link } from '@brillout/docpress'

> The `onBeforeRender()` hook is for expert Vike users. If you're new to Vike, we recommend using the
> <Link href="/data">`data()` hook</Link> instead, and/or <Link href="/vike-packages">Vike extensions</Link> for
> automatically integrating with data fetching tools (RPC with Telefunc/tRPC, REST with Tanstack Query, GraphQL with Apollo/Relay, etc).

The `onBeforeRender()` hook is used for deep and complex integrations with data fetching tools.

For simple data fetching needs, use the <Link href="/data">`data()` hook</Link> instead.

As a strategy to decide which one to use, first try to use the `data()` hook, and use `onBeforeRender()` only as a fallback if `data()` doesn't work out for you.

The `onBeforeRender()` is usually used to orchestrate mutliple <Link href="/meta">custom hooks and settings</Link>, see:
 - <Link href="#onbeforerender-meta" doNotInferSectionTitle />
 - <Link href="#advanced-example" />


## `onBeforeRender()` VS `data()`

The difference between the two hooks is that the value returned by the `data()` hook always sets the value of `pageContext.data`, whereas `onBeforeRender()` can set any and multiple `pageContext` values.

```js
// /pages/some-page/+data.js

export function data() {
  const someValue = /* ... */
  // pageContext.data === someValue
  return someValue
}
```

```js
// /pages/some-page/+onBeforeRender.js

export function data() {
  const someValue1 = /* ... */
  const someValue2 = /* ... */
  // pageContext.prop1 === someValue1
  // pageContext.prop2 === someValue2
  return {
    pageContext: {
      prop1: someValue1,
      prop2: someValue2
    }
  }
}
```

Another difference is that the entire `pageContext.data` value is always sent to the client-side, whereas with `onBeforeRender()` you can (and have to) decide which values are sent to the client-side by using <Link href="/passToClient">`passToClient`</Link>.

While `onBeforeRender()` requires more manual work, it also gives you more control.

Also, a common use case is to use `onBeforeRender()` as a global initializing hook.


## `onBeforeRender()` + `meta`

For more convenience, instead of creating a new `onBeforeRender()` hook for each page, you can define `onBeforeRender()`
only once in `/pages/+onBeforeRender.js` while <Link text="creating new settings" href="/meta" />.

For example:

```js
// /pages/user/+sql.js
export default { modelName: 'User', select: ['firstName', 'lastName'] }
```

```js
// /pages/product/+sql.js
export default { modelName: 'Product', select: ['name', 'price'] }
```

See full implementation at <Link href="/meta#example-sql" doNotInferSectionTitle />.


## Override

There can be only one `onBeforeRender()` hook per page. For example, if you define a global `onBeforeRender()` hook at `/pages/+onBeforeRender.js` as well as a page-specific one at `/pages/star-wars/+onBeforeRender.js` then the page-specific one overrides the global one.

> If you want multiple `onBeforeRender()` hooks, consider:
> - <Link href="/meta">Creating custom hooks</Link> instead: you can then use one global `onBeforeRender()` hook that orchestrates many custom hooks.
> - Using <Link href="/data">`data()` hooks</Link>: you can then use one global `onBeforeRender()` and page-specific `data()` hooks.

You can also suppress globally defined `onBeforeRender()` hooks on a per-page basis:
```js
// /pages/+onBeforeRender.js

// Some global onBeforeRender() hook
export default () => {
  // ...
}
```
```js
// /pages/some-page/+config.h.js

export default {
  // Suppress the global onBeforeRender() hook
  onBeforeRender: null
}
```


## Advanced example

The following is an advanced example of using `onBeforeRender()` with `meta` to integrate data fetching tools. This approach can be used to integrate GraphQL tools.

> If you use a custom renderer instead of <IntegrationPackageNames />, then you can modify your `onRenderHtml()` and `onRenderClient()` hooks instead of doing the following.

```js
// /pages/+config.h.js
// Environment: config

export default {
  // Pass the GraphQL cache to the client-side
  passToClient: ['cache'],
  // Modify/create hooks
  meta: {
    onBeforeRender: {
      // Modify built-in onBeforeRender() hook to run on both server- and client-side
      env: { client: true, server: true }
    },
    // Create a new hook
    onBeforeRenderHtml: {
      env: { server: true }
    },
    // Create a new hook
    onBeforeRenderClient: {
      env: { client: true }
    }
  }
}
```
> See:
>  - <Link href="/meta" />
>  - <Link href="/passToClient" />

```js
// /pages/+onBeforeRender.js
// Environment: server or client

export function async onBeforeRender(pageContext) {
  // When run on the server-side
  if (pageContext.config.onBeforeRenderHtml) {
    const { pageContext } = await onBeforeRenderHtml(pageContext)
    return { pageContext }
  }
  // When run on the client-side
  if (pageContext.config.onBeforeRenderClient) {
    onBeforeRenderClient(pageContext)
  }
}
```

```js
// /pages/+onBeforeRenderHtml.jsx
// Environment: server

import { renderToHtml } from 'my-graphql-tool/server'

export async function onBeforeRenderHtml(pageContext) {
  const { Page } = pageContext
  // `cache` contains the data fetched by GraphQL
  const { cache, html } = await renderToHtml(<Page>)
  return {
    pageHtml: html,
    cache
  }
}
```

```js
// /pages/+onBeforeRenderClient.jsx
// Environment: client

import { hydrate } from 'my-ui-framework/client'
import { CacheProvider } from 'my-graphql-tool/client'

export function onBeforeRenderClient(pageContext) {
  const { Page, cache } = pageContext
  hydrate(
    // Re-use the `cache` data that was fetched on the server-side
    <CacheProvider cache={cache}>
      <Page>
    </CacheProvider>,
    document.getElementById('root')
  )
}
```


## TypeScript

```ts
export { onBeforeRender }

import type { OnBeforeRenderAsync } from 'vike/types'

const onBeforeRender: OnBeforeRenderAsync = async (
  pageContext
): ReturnType<OnBeforeRenderAsync> => {
  // ...
}
```

<HookTypeScriptHints hookTypeName="OnBeforeRenderAsync" />
