import { HookTypeScriptHints } from '../components'
import { Link } from '@brillout/docpress'

The `onBeforeRender()` hook is usually used together with [`passToClient`](/passToClient) to fetch data, see [Guides > Data Fetching](/data-fetching).

By default it is only loaded in Node.js, so ORM/SQL database queries can be used.

```js
// /pages/movies/+onBeforeRender.js

// Note how we use `node-fetch`; this file is only run in Node.js by default, thus we don't need
// to use an isomorphic (aka universal) implementation such as `cross-fetch`.
import fetch from 'node-fetch'

export { onBeforeRender }

async function onBeforeRender(pageContext){
  const response = await fetch("https://api.imdb.com/api/movies/")
  const { movies } = await response.json()
  /* Or with an ORM:
  const movies = Movie.findAll() */
  /* Or with SQL:
  const movies = sql`SELECT * FROM movies;` */
  return {
    pageContext: {
      pageProps: {
        movies
      }
    }
  }
}
```

Examples:
- <Link href='/examples/react-full-v1/pages/star-wars/index/+onBeforeRender.ts' />
- <Link href='/examples/vue-full-v1/pages/star-wars/index/+onBeforeRender.ts' />

You can also provide initial `pageContext` values at your server middleware with <Link text={<code>renderPage(pageContextInit)</code>} href="/renderPage" />.
This is where you usually pass information about the authenticated user
(see <Link href="/auth" />).

> You can also suppress on a per-page basis globally defined `onBeforeRender()` hooks:
> ```js
> // /pages/+onBeforeRender.js
>
> // Some global onBeforeRender() hook
> export default () => {
>   // ...
> }
> ```
> ```js
> // /pages/some-page/+config.h.js
>
> export default {
>   // Suppress the global onBeforeRender() hook
>   onBeforeRender: null
> }
> ```


## Client-side

By default, `onBeforeRender()` always runs on the server-side.
But,
by [using `meta`](/meta#modify-existing-configurations),
you have the option to also run `onBeforeRender()` on the client-side;
the hook is then called not only in Node.js but also in the browser.

For the first page the user visits `onBeforeRender()` is called in Node.js
while for any subsequent page navigation `onBeforeRender()` is called in the browser.

> This option is only available if you use <Link href="/clientRouting" noBreadcrumb />.

In general, we recommend running `onBeforeRender()` only server-side since it's easier to write code that only runs
in Node.js.

That said, if we want to minimize requests made to our Node.js server, then we may want to run `onBeforeRender()` client-side too.
But then we need to ensure that our `onBeforeRender()` hook is isomorphic: it needs to be able to run in both Node.js and the browser.

Example:
 - [/examples/react-full-v1/](https://github.com/vikejs/vike/blob/01cc674498ea8baa289bfccb633d04b4d6cc7958/examples/react-full-v1/)
   - Config defintion: [/renderer/+config.h.ts > `meta.onBeforeRenderIsomorph`](https://github.com/vikejs/vike/blob/01cc674498ea8baa289bfccb633d04b4d6cc7958/examples/react-full-v1/renderer/+config.h.ts#L14-L33)
   - Config usage: [/pages/star-wars/@id/+onBeforeRenderIsomorph.ts](https://github.com/vikejs/vike/blob/01cc674498ea8baa289bfccb633d04b4d6cc7958/examples/react-full-v1/pages/star-wars/@id/+onBeforeRenderIsomorph.ts)
   - Hook: [/pages/star-wars/@id/+onBeforeRender.tsx](https://github.com/vikejs/vike/blob/01cc674498ea8baa289bfccb633d04b4d6cc7958/examples/react-full-v1/pages/star-wars/@id/+onBeforeRender.tsx)


## Server Routing

If we use <Link href="/server-routing" noBreadcrumb={true} /> we shouldn't
[modify the `meta` config](/meta#modify-existing-configurations) to run `onBeforeRender()` in the browser, as this would
cause the browser to load `onBeforeRender()` but never call it.


## TypeScript


```ts
export { onBeforeRender }

import type { OnBeforeRenderAsync } from 'vike/types'

const onBeforeRender: OnBeforeRenderAsync = async (
  pageContext
): ReturnType<OnBeforeRenderAsync> => {
  const response = await fetch("https://api.imdb.com/api/movies/")
  const { movies } = await response.json()
  return {
    pageContext: {
      pageProps: {
        movies
      }
    }
  }
}
```

<HookTypeScriptHints hookTypeName="OnBeforeRenderAsync" />
