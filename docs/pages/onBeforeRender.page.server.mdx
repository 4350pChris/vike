import { HookTypeScriptHints } from '../components'
import { Link } from '@brillout/docpress'

> The `onBeforeRender()` hook is for expert Vike users. If you're new to Vike, we recommend using the
> <Link href="/data">`data()` hook</Link> instead, and/or <Link href="/vike-packages">Vike extensions</Link> for deep
> integrations with GraphQL, RPC, Tanstack Query, etc.

The `onBeforeRender()` hook is usually used for fetching data, see <Link href="/data-fetching" />.

## Server-side

By default `onBeforeRender()` is loaded and executed only on the server-side. Thus you can directly use ORM/SQL database queries:

```js
// /pages/movies/+onBeforeRender.js

export { onBeforeRender }

// Note how we use `node-fetch`; this file is only run on the server-side, thus we don't need
// to use an isomorphic (aka universal) implementation such as `cross-fetch`.
import fetch from 'node-fetch'

async function onBeforeRender(pageContext) {
  const response = await fetch("https://api.imdb.com/api/movies/")
  const { movies } = await response.json()
  /* Or with an ORM:
  const movies = Movie.findAll() */
  /* Or with SQL:
  const movies = sql`SELECT * FROM movies;` */

  // We make `movies` available as pageContext.pageProps.movies
  return {
    pageContext: {
      pageProps: {
        movies
      }
    }
  }
}
```

```js
// /renderer/+onRenderHtml.js
// Environment: server

export { onRenderHtml }

import { escapeInject, dangerouslySkipEscape } from 'vike/server'
import { renderToHtml, createElement } from 'some-ui-framework'

async function onRenderHtml(pageContext) {
  const { Page, pageProps } = pageContext
  const pageHtml = await renderToHtml(
    // We pass pageContext.pageProps to the <Page> component
    createElement(Page, pageProps)
  )
  /* JSX:
  const pageHtml = await renderToHtml(<Page {...pageProps} />)
  */

  return escapeInject`<html>
    <div id='view-root'>
      ${dangerouslySkipEscape(pageHtml)}
    </div>
  </html>`
}
```

```js
// /renderer/+config.h.js
// Environment: config

export default {
  // Make pageContext.pageProps available in the browser
  passToClient: ['pageProps']
}
```

```js
// /renderer/+onRenderClient.js
// Environment: browser

export { onRenderClient }

import { hydrateDom, createElement } from 'some-ui-framework'

async function onRenderClient(pageContext) {
  // Thanks to `passToClient = ['pageProps']` our pageContext.pageProps is
  // available here in the browser.
  const { Page, pageProps } = pageContext
  await hydrateDom(
    // We pass pageContext.pageProps to the <Page> component
    createElement(Page, pageProps),
    document.getElementById('view-root')
  )
  /* JSX:
  await hydrateDom(<Page {...pageProps} />, document.getElementById('view-root'))
  */
}
```

```js
// /pages/movies/+Page.js
// Environment: browser and server

export { Page }

// In the onRenderHtml() and onRenderClient() hooks above, we pass
// pageContext.pageProps to the <Page> component
function Page(pageProps) {
  const { movies } = pageProps
  // ...
}
```

> Note that Vike doesn't know anything about `pageProps`: it's just an object we create in order to conveniently pass all the page's props at once.

## Examples

- <Link href='/examples/react-full-v1/pages/star-wars/index/+onBeforeRender.ts' />
- <Link href='/examples/vue-full-v1/pages/star-wars/index/+onBeforeRender.ts' />


## Initial `pageContext` values

You can provide initial `pageContext` values at your server middleware with <Link text={<code>renderPage(pageContextInit)</code>} href="/renderPage" />.
This is where you usually pass information about the authenticated user
(see <Link href="/auth" />).

> For <Link href="/pre-rendering" >pre-rendered</Link> apps, see [#962 - New hook `onStartup()`](https://github.com/vikejs/vike/issues/962).


## Override

There can be only one `onBeforeRender()` hook per page. For example, if you define a global `onBeforeRender()` hook at `/pages/+onBeforeRender.js` as well as a page-specific one at `/pages/star-wars/+onBeforeRender.js` then the page-specific one overrides the global one.

> If you want multiple `onBeforeRender()` hooks, consider:
> * <Link href="/meta">creating custom hooks</Link> instead: you can then use one global `onBeforeRender()` hook that orchestrates many custom hooks.
> * also using <Link href="/data">`data()` hooks</Link>: you can then use one global `onBeforeRender()` and a page-specific `data()` hook.

You can also suppress globally defined `onBeforeRender()` hooks on a per-page basis:
```js
// /pages/+onBeforeRender.js

// Some global onBeforeRender() hook
export default () => {
  // ...
}
```
```js
// /pages/some-page/+config.h.js

export default {
  // Suppress the global onBeforeRender() hook
  onBeforeRender: null
}
```


## Client-side

By default, `onBeforeRender()` always runs on the server-side and the fetched data is made available on the client-side
by setting <Link href="/passToClient">`passToClient`</Link>.

But,
by <Link href="/meta#example-modify-onbeforerender-env">using `meta`</Link>,
you can tell Vike to run `onBeforeRender()` also on the client-side: Vike calls `onBeforeRender()` on the server-side for the first page the user visits
and then, for subsequent page navigations, Vike calls `onBeforeRender()` on the client-side.

> This option is only available if you use <Link href="/client-routing" >Client Routing</Link>.

In general, we recommend running `onBeforeRender()` only on the server-side because it's usually easier to write code that only runs on the server-side.
That said, if you want to minimize requests made to your server, then it makes sense to run `onBeforeRender()` on the client-side.
Keep in mind that you'll then have to ensure that your `onBeforeRender()` hook is isomorphic: it needs to be able to run on the server-side as well as on the client-side.

You can also set `onBeforeRender()`'s meta config `env` to `{ client: true, server: false}`: Vike will then always call `onBeforeRender()` on the client-side and never on the server-side.

Example:
 - [/examples/react-full-v1/](https://github.com/vikejs/vike/blob/01cc674498ea8baa289bfccb633d04b4d6cc7958/examples/react-full-v1/)
   - Config defintion: [/renderer/+config.h.ts > `meta.onBeforeRenderIsomorph`](https://github.com/vikejs/vike/blob/01cc674498ea8baa289bfccb633d04b4d6cc7958/examples/react-full-v1/renderer/+config.h.ts#L14-L33)
   - Config usage: [/pages/star-wars/@id/+onBeforeRenderIsomorph.ts](https://github.com/vikejs/vike/blob/01cc674498ea8baa289bfccb633d04b4d6cc7958/examples/react-full-v1/pages/star-wars/@id/+onBeforeRenderIsomorph.ts)
   - Hook: [/pages/star-wars/@id/+onBeforeRender.tsx](https://github.com/vikejs/vike/blob/01cc674498ea8baa289bfccb633d04b4d6cc7958/examples/react-full-v1/pages/star-wars/@id/+onBeforeRender.tsx)


## Custom settings

For more convenience, instead of creating a new `onBeforeRender()` hook for each page, we can define `onBeforeRender()`
only once in `/renderer/+onBeforeRender.js` while <Link text="creating new settings" href="/meta" />.

For example:

```js
// /pages/user/+sql.js
export default { modelName: 'User', select: ['firstName', 'lastName'] }
```

```js
// /pages/product/+sql.js
export default { modelName: 'Product', select: ['name', 'price'] }
```

See full implementation at <Link href="/meta#example-sql" doNotInferSectionTitle />.


## TypeScript

```ts
export { onBeforeRender }

import type { OnBeforeRenderAsync } from 'vike/types'

const onBeforeRender: OnBeforeRenderAsync = async (
  pageContext
): ReturnType<OnBeforeRenderAsync> => {
  // ...
}
```

<HookTypeScriptHints hookTypeName="OnBeforeRenderAsync" />
