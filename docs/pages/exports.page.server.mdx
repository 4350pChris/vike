import { Link } from '@brillout/docpress'

`pageContext.exports` holds the `export` values of:
 - The current page's `+Page.js` file.
 - The `+onRenderHtml.js` and `+onRenderClient.js` files.

More generally, it holds the `export` values of any `+*.js` file related to the current page.

For example:

```js
// /pages/countries/+Page.js
// Environment: server and browser

export const title = 'Earth Countries'
export const dataUrl = 'https://restcountries.com/v3.1/all'
```

```js
// /renderer/+onBeforeRender.js
// Environment: server

export { onBeforeRender }

import fetch from 'node-fetch'

async function onBeforeRender(pageContext) {
  const response = await fetch(pageContext.exports.dataUrl)
  // ...
}
```

```js
// /renderer/+onRenderHtml.js
// Environment: server

export { onRenderHtml }

async function onRenderHtml(pageContext) {
   const titleTag = `<title>${pageContext.exports.title}</title>`
   // ...
}
```

```js
// /renderer/+onRenderClient.js
// Environment: browser

export { onRenderClient }

async function onRenderClient(pageContext) {
  if (!pageContext.isHydration) {
    // Update the website's title upon page navigation.
    document.title = pageContext.exports.title
  }
  // ...
}
```

```js
// /renderer/+config.h.js
// Environment: build-time

export default {
  clientRouting: true
}
```

> Note how `pageContext.exports.title` is available in both Node.js and the browser: that's because `export { title }`
is defined in a `+Page.js` file which is, by default, loaded in Node.js as well as in the browser.

We call this technique *Custom Exports* / *Custom Hooks*.


## Using `meta` configs

In the previous example `pageContext.exports.dataUrl` is available both in Node.js and the browser, although it is
needed only in Node.js. This can be improved by declaring `dataUrl` as a <Link href="/meta">`meta` config</Link> and
defining it in a `+dataUrl.js` file:

```js
// /renderer/+config.h.js
// Environment: build-time

export default {
  clientRouting: true,
  meta: {
    dataUrl: {
      env: 'server-only'
    }
  }
}
```

```js
// /pages/countries/+dataUrl.js
// Environment: server

export default 'https://restcountries.com/v3.1/all'
```


## Example: Page Layout

A common technique is to use a custom export `pageContext.exports.Layout` to define the layout of a page.

```js
// /pages/product/+Page.js
// Environment: browser and server

export { Layout } from '../layouts/Responsive'
export function Page() {
   /* ... */
}
```

```js
// /pages/admin/+Page.js
// Environment: browser and server

export { Layout } from '../layouts/Dashboard'
export function Page() {
   /* ... */
}
```

```js
// /renderer/+onRenderHtml.js
// Environment: server

export { onRenderHtml }

import { renderToHtml } from 'some-ui-framework'
import { escapeInject, dangerouslySkipEscape } from 'vike/server'

async function onRenderHtml(pageContext) {
  const { Page, Layout } = pageContext.exports
  const pageHtml = renderToHtml(<Layout><Page /></Layout>)
  return escapeInject`<!DOCTYPE html>
    <html>
      <body>
        <div id="root">${dangerouslySkipEscape(pageHtml)}</div>
      </body>
    </html>`
}
```

```js
// /renderer/+onRenderClient.jsx
// Environment: browser

export { onRenderClient }

import { renderDom } from 'some-ui-framework'

async function onRenderClient(pageContext) {
  // `+Page.js` files are also loaded in the browser: `Layout` and `Page` are also available here
  const { Page, Layout } = pageContext.exports
  renderDom(
    <Layout><Page /></Layout>,
    document.getElementById("root")
  )
}
```

> Note how we use `pageContext.exports.Page` instead of `pageContext.Page`: that's because `pageContext.Page` is actually just an alias for `pageContext.exports.Page ?? pageContext.exports.default`.


## Example: Data Query

Another common example is to use a custom export `pageContext.exports.query` to define the data query of a page.

```js
// /pages/product/+Page.js
export const query = { modelName: 'Product', select: ['name', 'price'] }
```

```js
// /pages/user/+Page.js
export const query = { modelName: 'User', select: ['firstName', 'lastName'] }
```

```js
// /renderer/+onBeforeRender.js
// Environment: server

export { onBeforeRender }

import { runQuery } from 'some-sql-engine'

async function onBeforeRender(pageContext) {
  const { query } = pageContext.exports
  const data = await runQuery(query)
  const pageProps = { data }
  return { pageContext: { pageProps } }
}
```

```js
// /renderer/+onRenderHtml.js
// Environment: server

export { onRenderHtml }

import { renderToHtml } from 'some-ui-framework'
import { escapeInject, dangerouslySkipEscape } from 'vike/server'

async function onRenderHtml(pageContext) {
  const { Page, pageProps } = pageContext
  const pageHtml = renderToHtml(<Page {...pageProps} />)
  return escapeInject`<!DOCTYPE html>
    <html>
      <body>
        <div id="root">${dangerouslySkipEscape(pageHtml)}</div>
      </body>
    </html>`
}
```

```js
// /renderer/+config.h.js
// Environment: build-time

export default {
  passToClient: ['pageProps']
}
```

```js
// /renderer/+onRenderClient.jsx
// Environment: browser

export { onRenderClient }

import { renderDom } from 'some-ui-framework'

async function onRenderClient(pageContext) {
  const { Page, pageProps } = pageContext
  renderDom(
    <Page {...pageProps} />,
    document.getElementById("root")
  )
}
```

## Example: Meta Data

We can also use custom exports to define the metadata of a page.

```js
// /pages/product/+Page.js
export const title = 'Product'
export const getDescription = pageProps => `Product: ${pageProps.productName}`
```

```js
// /pages/user/+Page.js
export const title = 'User'
export const getDescription = pageProps => `User: ${pageProps.firstName} ${pageProps.lastName}`
```

```js
// /renderer/+onRenderHtml.js
// Environment: server

export { onRenderHtml }

import { renderToHtml } from 'some-ui-framework'
import { escapeInject, dangerouslySkipEscape } from 'vike/server'

async function onRenderHtml(pageContext) {
  const { Page, pageProps } = pageContext
  const { title, getDescription } = pageContext.exports
  const description = getDescription(pageProps)
  const pageHtml = renderToHtml(<Page {...pageProps} />)
  return escapeInject`<!DOCTYPE html>
    <html>
      <head>
        <title>${title}</title>
        <meta name="description" content="${description}" />
      </head>
      <body>
        <div id="root">${dangerouslySkipEscape(pageHtml)}</div>
      </body>
    </html>`
}
```
